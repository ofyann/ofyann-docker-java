name: Docker Build and Push

on:
  schedule:
    # 每天 UTC 00:00 检查新版本并构建
    - cron: '0 0 * * *'
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/docker-build.yml'
      - 'build.sh'
  workflow_dispatch:
    inputs:
      force_build:
        description: '强制重新构建所有版本'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY_DOCKERHUB: docker.io
  IMAGE_NAME: ofyann/java

jobs:
  # 第一步：获取所有版本的最新信息
  fetch-versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.fetch.outputs.matrix }}

    steps:
      - name: Fetch latest versions from Adoptium API
        id: fetch
        run: |
          # 定义需要的 Java 大版本
          JAVA_VERSIONS="8 17 21 25"

          echo "正在获取版本信息..."
          MATRIX_JSON='{"include":[]}'

          for version in $JAVA_VERSIONS; do
            echo "检查 Java $version..."

            # 从 Adoptium API 获取最新版本信息（过滤标准 JDK）
            API_URL="https://api.adoptium.net/v3/assets/latest/${version}/hotspot?image_type=jdk&os=linux&architecture=x64"
            RESPONSE=$(curl -s "$API_URL")

            if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "[]" ]; then
              echo "警告: Java $version 暂无可用版本"
              continue
            fi

            # 解析版本信息
            VERSION_OBJ=$(echo "$RESPONSE" | jq -r '.[0].version')
            SEMVER=$(echo "$VERSION_OBJ" | jq -r '.semver')
            OPENJDK_VERSION=$(echo "$VERSION_OBJ" | jq -r '.openjdk_version')

            # 根据不同的 Java 版本构建不同的标签格式
            if [ "$version" = "8" ]; then
              # Java 8: openjdk_version "1.8.0_472-b08" -> 8u472-b08
              SECURITY=$(echo "$OPENJDK_VERSION" | sed -n 's/.*_\([0-9]*\).*/\1/p')
              BUILD=$(echo "$OPENJDK_VERSION" | sed -n 's/.*-\(b[0-9]*\).*/\1/p')

              if [ -n "$SECURITY" ] && [ -n "$BUILD" ]; then
                UPDATE="8u${SECURITY}"
                FULL_VERSION="${UPDATE}${BUILD}"         # 8u472b08
                DOWNLOAD_VERSION="${UPDATE}-${BUILD}"    # 8u472-b08
              else
                echo "无法解析 Java 8 版本号: $OPENJDK_VERSION"
                continue
              fi
            else
              # Java 11+: semver "17.0.17+10" 或 "21.0.9+10.0.LTS"
              # 去除 .LTS 后缀
              CLEAN_SEMVER=$(echo "$SEMVER" | sed 's/\.0\.LTS$//' | sed 's/-LTS$//')

              # 提取版本号: 17.0.17+10 -> 17.0.17 和 10
              UPDATE=$(echo "$CLEAN_SEMVER" | sed -n 's/^\([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p')
              BUILD=$(echo "$CLEAN_SEMVER" | sed -n 's/.*+\([0-9]*\).*/\1/p')

              if [ -n "$UPDATE" ] && [ -n "$BUILD" ]; then
                FULL_VERSION="${UPDATE}_${BUILD}"        # 17.0.17_10
                DOWNLOAD_VERSION="${UPDATE}+${BUILD}"    # 17.0.17+10
              else
                echo "无法解析 Java ${version} 版本号: $SEMVER"
                continue
              fi
            fi

            echo "  版本: $FULL_VERSION"

            # 添加到 matrix
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq \
              --arg major "$version" \
              --arg full "$FULL_VERSION" \
              --arg dl "$DOWNLOAD_VERSION" \
              '.include += [{
                "java_major": $major,
                "full_version": $full,
                "download_version": $dl
              }]')
          done

          echo "生成的 matrix:"
          echo "$MATRIX_JSON" | jq .

          # 输出 matrix（压缩为单行）
          MATRIX_COMPACT=$(echo "$MATRIX_JSON" | jq -c .)
          echo "matrix=$MATRIX_COMPACT" >> $GITHUB_OUTPUT

  # 第二步：构建和推送 Docker 镜像
  build-and-push:
    needs: fetch-versions
    runs-on: ubuntu-latest
    if: needs.fetch-versions.outputs.matrix != '' && needs.fetch-versions.outputs.matrix != '{"include":[]}'

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.fetch-versions.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check if image exists
        id: check
        continue-on-error: true
        run: |
          # 检查具体版本的镜像是否已存在
          if docker manifest inspect ${{ env.IMAGE_NAME }}:${{ matrix.full_version }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "镜像 ${{ matrix.full_version }} 已存在"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "镜像 ${{ matrix.full_version }} 不存在，需要构建"
          fi

      - name: Build download URL
        id: build_url
        if: steps.check.outputs.exists != 'true' || github.event.inputs.force_build == 'true'
        run: |
          JAVA_MAJOR=${{ matrix.java_major }}
          DOWNLOAD_VERSION="${{ matrix.download_version }}"

          if [ "$JAVA_MAJOR" = "8" ]; then
            # Java 8: OpenJDK8U-jdk_x64_linux_hotspot_8u472b08.tar.gz
            # URL: jdk8u472-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u472b08.tar.gz
            # 文件名格式: 移除 '-' 但保留 'u'
            VERSION_CLEAN=$(echo "$DOWNLOAD_VERSION" | tr -d '-')
            JAVA_URL="https://github.com/adoptium/temurin${JAVA_MAJOR}-binaries/releases/download/jdk${DOWNLOAD_VERSION}/OpenJDK${JAVA_MAJOR}U-jdk_x64_linux_hotspot_${VERSION_CLEAN}.tar.gz"
          else
            # Java 11+: OpenJDK17U-jdk_x64_linux_hotspot_17.0.15_6.tar.gz
            # URL: jdk-17.0.15%2B6/OpenJDK17U-jdk_x64_linux_hotspot_17.0.15_6.tar.gz
            VERSION_UNDERSCORE="${{ matrix.full_version }}"
            DOWNLOAD_ENCODED=$(echo "$DOWNLOAD_VERSION" | sed 's/+/%2B/g')
            JAVA_URL="https://github.com/adoptium/temurin${JAVA_MAJOR}-binaries/releases/download/jdk-${DOWNLOAD_ENCODED}/OpenJDK${JAVA_MAJOR}U-jdk_x64_linux_hotspot_${VERSION_UNDERSCORE}.tar.gz"
          fi

          echo "java_url=${JAVA_URL}" >> $GITHUB_OUTPUT
          echo "下载 URL: ${JAVA_URL}"

      - name: Build and push Docker image
        if: steps.check.outputs.exists != 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ matrix.java_major }}
            ${{ env.IMAGE_NAME }}:${{ matrix.full_version }}
          build-args: |
            JAVA_MAJOR=${{ matrix.java_major }}
            JAVA_VERSION=${{ matrix.java_major }}
            JAVA_URL=${{ steps.build_url.outputs.java_url }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.java_major }}
          cache-to: type=gha,mode=max,scope=${{ matrix.java_major }}

      - name: Test image
        if: steps.check.outputs.exists != 'true' || github.event.inputs.force_build == 'true'
        run: |
          echo "测试镜像: ${{ env.IMAGE_NAME }}:${{ matrix.full_version }}"
          docker run --rm ${{ env.IMAGE_NAME }}:${{ matrix.full_version }} java -version
          docker run --rm ${{ env.IMAGE_NAME }}:${{ matrix.full_version }} javac -version

          # 测试时区
          TZ=$(docker run --rm ${{ env.IMAGE_NAME }}:${{ matrix.full_version }} date +%Z)
          echo "容器时区: $TZ"

          # 测试中文支持
          docker run --rm ${{ env.IMAGE_NAME }}:${{ matrix.full_version }} locale | grep -i "utf"

          echo "✓ 测试通过"

      - name: Update version info
        if: steps.check.outputs.exists != 'true' || github.event.inputs.force_build == 'true'
        run: |
          echo "Java ${{ matrix.java_major }} - ${{ matrix.full_version }} 构建完成" >> $GITHUB_STEP_SUMMARY
          echo "镜像标签:" >> $GITHUB_STEP_SUMMARY
          echo "  - ${{ env.IMAGE_NAME }}:${{ matrix.java_major }}" >> $GITHUB_STEP_SUMMARY
          echo "  - ${{ env.IMAGE_NAME }}:${{ matrix.full_version }}" >> $GITHUB_STEP_SUMMARY

  # 第三步：生成构建报告
  report:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate report
        run: |
          echo "## 构建报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "构建时间: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "触发方式: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "支持的 Java 版本: 8, 17, 21, 25" >> $GITHUB_STEP_SUMMARY
          echo "镜像仓库: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
